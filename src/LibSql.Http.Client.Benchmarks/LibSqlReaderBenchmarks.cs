using System.Text;
using System.Text.Json.Serialization;
using BenchmarkDotNet.Attributes;
using LibSql.Http.Client.Response;

namespace LibSql.Http.Client.Benchmarks;

[MemoryDiagnoser]
public class LibSqlReaderBenchmarks
{
    private static readonly string Response =
        @"{""baton"":null,""base_url"":null,""results"":[{""type"":""ok"",""response"":{""type"":""execute"",""result"":{""cols"":[{""name"":""Id"",""decltype"":""VARCHAR(50)""},{""name"":""Name"",""decltype"":""VARCHAR(255)""},{""name"":""CreatedAt"",""decltype"":""TIMESTAMP""},{""name"":""UpdatedAt"",""decltype"":""TIMESTAMP""}],""rows"":[[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}],[{""type"":""text"",""value"":""01j1fecvt1dr0qhastbx9cp8y3""},{""type"":""text"",""value"":""Name 1""},{""type"":""integer"",""value"":""1719836517919""},{""type"":""integer"",""value"":""1719836517919""}]],""affected_row_count"":0,""last_insert_rowid"":null,""replication_index"":""53"",""rows_read"":1,""rows_written"":0,""query_duration_ms"":0.098}}},{""type"":""ok"",""response"":{""type"":""close""}}]}";

    [Benchmark]
    public async Task<object?> ExecuteLite()
    {
        var content = new StringContent(Response, Encoding.UTF8, "application/json");
        using var reader = await ResultReader.ParseAsync(content);

        return reader.ReadAt(0, TestSerializerContext.Default.TestResultType);
    }
}

public record TestResultType(string Id, string Name, long CreatedAt, long UpdatedAt);

[JsonSerializable(typeof(TestResultType))]
public partial class TestSerializerContext : JsonSerializerContext;
